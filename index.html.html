import wixData from "wix-data";

// ===============================================================
// PAGE READY
// ===============================================================
$w.onReady(function () {

    console.log("WHOLESALE PAGE — READY");

    // Tell iframe we are in WHOLESALE MODE
    $w("#html1").postMessage({
        type: "WF_SET_MODE",
        mode: "wholesale",
        pricing: "wholesale"
    });

    // Listen for messages from iframe
    $w("#html1").onMessage((rawEvent) => {

        let msg = rawEvent.data;
        console.log("MESSAGE RECEIVED:", msg);

        if (!msg || !msg.type) return;

        if (msg.type === "WF_GET_BREEDS") sendBreeds();
        if (msg.type === "WF_GET_HATCHDATES") sendHatchDates();

        if (msg.type === "WF_ORDER_SUBMIT") {
            console.log("ORDER SUBMIT RECEIVED:", msg.data);
            handleOrderSubmit(msg.data);
        }
    });

});
    

// ===============================================================
// SEND BREEDS BACK TO IFRAME — NOW INCLUDES RETAIL + WHOLESALE PRICING
// ===============================================================
function sendBreeds() {
    wixData.query("Breeds")
        .ascending("category")
        .ascending("displayName")
        .limit(1000)
        .find()
        .then(res => {

            const items = res.items.map(i => ({
                breedKey: i.breedKey,
                displayName: i.displayName,
                category: i.category,
                sexOption: i.sexOption,
                priceRetail: i.priceRetail,         // <— new
                price: i.price     // <— new
            }));

            console.log("Sending breeds:", items.length);

            $w("#html1").postMessage({
                type: "WF_RETURN_BREEDS",
                breeds: items
            });

        })
        .catch(err => console.error("Breed load error:", err));
}


// ===============================================================
// SEND HATCH DATES BACK TO IFRAME
// ===============================================================
function sendHatchDates() {
    wixData.query("hatchDates")
        .ascending("isoDate")
        .limit(1000)
        .find()
        .then(res => {

            const items = res.items.map(i => ({
                isoDate: i.isoDate
            }));

            console.log("Sending hatch dates:", items.length);

            $w("#html1").postMessage({
                type: "WF_RETURN_HATCHDATES",
                hatchDates: items
            });

        })
        .catch(err => console.error("Hatch date load error:", err));
}


// ===============================================================
// CUSTOMER LOOKUP BY EMAIL
// ===============================================================
function findCustomerByEmail(email) {
    return wixData.query("customerInfo")
        .eq("Email", email)
        .find()
        .then(res => res.items[0] || null);
}


// ===============================================================
// AUTO-INCREMENT CUSTOMER ID
// ===============================================================
function getNextCustomerID() {
    return wixData.query("customerInfo")
        .descending("CustomerID")
        .limit(1)
        .find()
        .then(res => {
            const last = res.items?.[0]?.CustomerID;
            return last ? last + 1 : 10000;
        });
}


// ===============================================================
// CREATE CUSTOMER RECORD
// ===============================================================
async function createCustomer(customer) {

    const nextID = await getNextCustomerID();

    const newCustomer = {
        CustomerID: nextID,
        FirstName: customer.FirstName,
        LastName: customer.LastName,
        Email: customer.Email,
        Phone: customer.Phone,
        FarmBusinessName: customer.FarmBusinessName,
        BillingAddress1: customer.BillingAddress1,
        BillingAddress2: customer.BillingAddress2,
        BillingCity: customer.BillingCity,
        BillingState: customer.BillingState,
        BillingZIP: customer.BillingZIP,
        ShippingAddress1: "",
        ShippingAddress2: "",
        ShippingCity: "",
        ShippingState: "",
        ShippingZIP: "",
        Notes: "",
        wholesaleTrue: true,
        active: true
    };

    return wixData.insert("customerInfo", newCustomer);
}


// ===============================================================
// AUTO-INCREMENT ORDER ID
// ===============================================================
function getNextOrderID() {
    return wixData.query("ChickOrders")
        .descending("orderID")
        .limit(1)
        .find()
        .then(r => (r.items?.[0]?.orderID || 30000) + 1);
}


// ===============================================================
// HANDLE ORDER SUBMISSION
// ===============================================================
async function handleOrderSubmit(orderData) {
    try {
        console.log("Handling WHOLESALE order submit...");

        const {
            hatchDate,
            grandQty,
            grandTotal,
            lines,
            customer,
            orderNotes
        } = orderData;


        // --- 1. CHECK OR CREATE CUSTOMER ---
        let customerRecord = await findCustomerByEmail(customer.Email);

        if (!customerRecord) {
            console.log("Customer not found — creating...");
            customerRecord = await createCustomer(customer);
        } else {
            console.log("Customer found:", customerRecord.CustomerID);
        }


        // --- 2. ORDER ID ---
        const nextID = await getNextOrderID();


        // --- 3. SAVE ORDER HEADER ---
        const orderObj = {
            orderID: nextID,
            title: `Order ${nextID} - ${hatchDate}`,
            hatchDate: hatchDate ? new Date(hatchDate) : null,
            totalQty: Number(grandQty),
            totalAmt: Number(grandTotal),
            customerRef: customerRecord._id,
            orderNotes: orderNotes || "",
            pricingType: "wholesale"
        };

        await wixData.insert("ChickOrders", orderObj);
        console.log("Order saved:", nextID);


        // --- 4. SAVE LINE ITEMS ---
        const inserts = lines.map(line =>
            wixData.insert("ChickOrderItems", {
                orderID: nextID,
                breedKey: line.breedKey,
                sex: line.sex,
                qty: Number(line.qty),
                price: Number(line.price),
                lineTotal: Number(line.lineTotal)
            })
        );

        await Promise.all(inserts);
        console.log("Line items saved");

    } catch (err) {
        console.error("Order save error:", err);
    }
}